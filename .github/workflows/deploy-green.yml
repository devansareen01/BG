name: Deploy to Green Environment

on:
  push:
    branches: [ Deploy ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
    - name: Deploy to Green Server
      run: |
        echo "ðŸš€ Starting Green deployment..."
        
        # Create SSH command with proper key handling
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_USERNAME }}@${{ secrets.GREEN_SERVER_HOST }} << 'EOF'
          echo "ðŸš€ Starting Green deployment..."
          
          # Debug: Check current directory and list contents
          echo "Current directory: $(pwd)"
          echo "Available directories:"
          ls -la
          
          # Navigate to application directory
          cd /green-app/BG || {
            echo "âŒ Failed to navigate to /green-app/BG"
            echo "Current directory: $(pwd)"
            echo "Available directories:"
            ls -la /green-app/ || echo "Directory /green-app/ does not exist"
            ls -la / || echo "Root directory contents:"
            exit 1
          }
          
          # Pull latest code from deploy branch
          git fetch origin
          git reset --hard origin/deploy
          
          # Install dependencies
          npm ci --production
          
          # Run database seeding
          echo "ðŸŒ± Running database seeding..."
          npm run seed
          
          # Restart application with PM2
          echo "ðŸ”„ Restarting application..."
          pm2 restart green-app
          
          # Wait for application to start
          sleep 10
          
          # Health check
          echo "ðŸ¥ Performing health check..."
          curl -f http://localhost:3000/health || exit 1
          
          echo "âœ… Green deployment completed successfully!"
        EOF
          
    # - name: Notify deployment status
    #   if: always()
    #   run: |
    #     if [ ${{ job.status }} == 'success' ]; then
    #       echo "âœ… Green deployment successful"
    #       curl -X POST -H 'Content-type: application/json' \
    #         --data "{
    #           \"text\": \"ðŸŽ‰ *Green Deployment Successful!*\",
    #           \"attachments\": [
    #             {
    #               \"color\": \"good\",
    #               \"fields\": [
    #                 {
    #                   \"title\": \"Environment\",
    #                   \"value\": \"Green (Staging)\",
    #                   \"short\": true
    #                 },
    #                 {
    #                   \"title\": \"Branch\",
    #                   \"value\": \"deploy\",
    #                   \"short\": true
    #                 },
    #                 {
    #                   \"title\": \"Status\",
    #                   \"value\": \"âœ… Success\",
    #                   \"short\": true
    #                 },
    #                 {
    #                   \"title\": \"Timestamp\",
    #                   \"value\": \"$(date -u +'%Y-%m-%d %H:%M:%S UTC')\",
    #                   \"short\": true
    #                 }
    #               ],
    #               \"footer\": \"Blue-Green Deployment Pipeline\"
    #             }
    #           ]
    #         }" \
    #         "https://hooks.slack.com/services/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"
    #     else
    #       echo "âŒ Green deployment failed"
    #       curl -X POST -H 'Content-type: application/json' \
    #         --data "{
    #           \"text\": \"ðŸš¨ *Green Deployment Failed!*\",
    #           \"attachments\": [
    #             {
    #               \"color\": \"danger\",
    #               \"fields\": [
    #                 {
    #                   \"title\": \"Environment\",
    #                   \"value\": \"Green (Staging)\",
    #                   \"short\": true
    #                 },
    #                 {
    #                   \"title\": \"Branch\",
    #                   \"value\": \"deploy\",
    #                   \"short\": true
    #                 },
    #                 {
    #                   \"title\": \"Status\",
    #                   \"value\": \"âŒ Failed\",
    #                   \"short\": true
    #                 },
    #                 {
    #                   \"title\": \"Timestamp\",
    #                   \"value\": \"$(date -u +'%Y-%m-%d %H:%M:%S UTC')\",
    #                   \"short\": true
    #                 }
    #               ],
    #               \"footer\": \"Blue-Green Deployment Pipeline\"
    #             }
    #           ]
    #         }" \
    #         "https://hooks.slack.com/services/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"
    #     fi
