name: Deploy to Blue Environment (Production)

on:
  push:
    branches: [ main ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
        
    - name: Deploy to Blue Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.BLUE_SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_SSH_PORT }}
        script: |
          echo "üöÄ Starting Blue deployment (Production)..."
          
          # Navigate to application directory
          cd /blue-app/BG
          
          # Pull latest code from main branch
          git fetch origin
          git reset --hard origin/main
          
          # Install dependencies
          npm ci --production
          
          # Restart application with PM2
          echo "üîÑ Restarting application..."
          pm2 restart blue-app
          
          # Wait for application to start
          sleep 10
          
          # Health check
          echo "üè• Performing health check..."
          curl -f http://localhost:3000/health || exit 1
          
          echo "‚úÖ Blue deployment completed successfully!"
          
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Blue deployment successful"
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"üéâ *Blue Deployment Successful!*\",
              \"attachments\": [
                {
                  \"color\": \"good\",
                  \"fields\": [
                    {
                      \"title\": \"Environment\",
                      \"value\": \"Blue (Production)\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Branch\",
                      \"value\": \"main\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Status\",
                      \"value\": \"‚úÖ Success\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Timestamp\",
                      \"value\": \"$(date -u +'%Y-%m-%d %H:%M:%S UTC')\",
                      \"short\": true
                    }
                  ],
                  \"footer\": \"Blue-Green Deployment Pipeline\"
                }
              ]
            }" \
            "https://hooks.slack.com/services/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"
        else
          echo "‚ùå Blue deployment failed"
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"üö® *Blue Deployment Failed!*\",
              \"attachments\": [
                {
                  \"color\": \"danger\",
                  \"fields\": [
                    {
                      \"title\": \"Environment\",
                      \"value\": \"Blue (Production)\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Branch\",
                      \"value\": \"main\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Status\",
                      \"value\": \"‚ùå Failed\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Timestamp\",
                      \"value\": \"$(date -u +'%Y-%m-%d %H:%M:%S UTC')\",
                      \"short\": true
                    }
                  ],
                  \"footer\": \"Blue-Green Deployment Pipeline\"
                }
              ]
            }" \
            "https://hooks.slack.com/services/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"
        fi
